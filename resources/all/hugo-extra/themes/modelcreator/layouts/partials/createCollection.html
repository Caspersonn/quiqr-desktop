{{- $collection := "" -}}
{{- $contentDir := (partial "getContentDir" . ) -}}
{{- $baseKey := partial "createKey" .  -}}
{{- $itemTitle :=  ( $baseKey | humanize) | singularize -}}
{{- $break := false }}
{{- $language := partial "getLanguage" . -}}
{{- $sectionKey := printf "c_%s_%s" $language $baseKey -}}

{{- if $language -}} {{ $language = (printf "%s | " $language) }} {{- end -}}

{{- $sectionTitle := printf "%s%s" $language ($baseKey | humanize) -}}

{{- range .Pages -}}
    {{- if and .File (ne $break "true") -}}
        {{- $break = true -}}
        {{- $subDir := path.Base .File.Dir -}}
        {{ if (in $baseKey $subDir) }}
            {{- $dir := printf "%s%s/" $contentDir $subDir -}}
            {{- $extension := .File.Ext -}}
            {{- $fields := slice -}}
            {{- $resourceDir := "" -}}
            {{- $page := . -}}
            {{- $filePath := "" -}}
            {{- with $page.File -}}{{- $filePath = .Path -}}{{- end -}}
            {{- if (index (readDir $dir) 0).IsDir -}}
                {{- $resourceDir = printf "%s%s" $dir (index (readDir $dir) 0).Name -}}
            {{- else -}}
                {{- $resourceDir = printf "%s%s" $dir (index (readDir $dir) 1).Name -}}
            {{- end -}}
            {{- $fields = $fields | append (partial "createResourceBundleManagers" (dict "page" $page "dir" $resourceDir )) -}}
            {{- $fields = $fields | append (partial "createField" (dict "value" .Content "key" "mainContent")) -}}
            {{- range $key, $value := .Page.Params -}}
            {{- if ne $key "mainContent" -}}
                    {{- $field := partial "createField" (dict "key" $key "value" $value "file" $filePath) -}}
                    {{- $fields = $fields | append $field -}}
                {{- end -}}
            {{- end -}}
            {{- $fields = partial "sortFields" $fields -}}
            {{- $collection =  dict "key" $sectionKey "title" $sectionTitle "folder" $dir "extension" $extension "dataformat" "yaml" "fields" $fields "itemtitle" $itemTitle  -}}
        {{- end -}}
    {{- end -}}
{{- end -}}
{{- return $collection -}}
