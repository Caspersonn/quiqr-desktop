{{- $file := .file -}}
{{- $key := .key -}}
{{- if .file -}}
    {{- $key = partial "getRealKey" (dict "key" .key "file" .file ) -}}
{{- end -}}
{{- $value := .value -}}
{{- $pogoType := "" -}}
{{- if .type -}}
    {{- $pogoType = .type -}}
{{- else -}}
    {{- $pogoType = partial "pogoType" (dict "value" $value "key" $key) -}}
{{- end -}}
{{- $title := humanize $key -}}
{{- $field := dict "key" $key "title" $title "type" $pogoType -}}
{{- if (eq $pogoType "date") -}}
    {{- $field = merge $field (dict "default" "now") -}}
{{- end -}}

{{- if (eq $pogoType "section") -}}
    {{- $subfields := slice -}}
    {{- range $key, $value := $value -}}
            {{- $pogoType := partial "pogoType" (dict "value" $value "key" $key) -}}
            {{- $field := partial "createField" (dict "value" $value "key" $key "file" $file) -}}
            {{- $subfields = $subfields | append $field}}
    {{- end -}}
    {{- $field = merge $field (dict "groupdata" true "fields" $subfields) -}}
{{- end -}}

{{- if (eq $pogoType "accordion") -}}
    {{- $subfields := slice -}}
    {{- $arrayTitle := "" -}}
    {{- $accordionKeys := slice -}}
    {{- $accordionItems := ( index $value 0 ) -}}
    {{- range $key, $value := $accordionItems -}}
        {{- $accordionKeys = $accordionKeys | append $key -}}
        {{- if or (eq $key "name") (eq $key "title") (eq $key "line") -}}
            {{- $arrayTitle = $key -}}
        {{- end -}}
    {{- end -}}
    {{- if eq $arrayTitle "" -}}
        {{ $arrayTitle = index $accordionKeys 0 -}}
    {{- end -}}
    {{- range $key, $value := $accordionItems -}}
            {{- $pogoType := partial "pogoType" (dict "value" $value "key" $key) -}}
            {{- $field := partial "createField" (dict "value" $value "key" $key "file" $file) -}}
            {{- if eq $key $arrayTitle -}}
                {{- $field = $field | merge (dict "arrayTitle" true ) -}}
            {{- end -}}
            {{- $subfields = $subfields | append $field -}}
    {{- end -}}
    {{- $field = merge $field (dict "fields" $subfields ) -}}
{{- end -}}

{{- if (eq $pogoType "bundle-manager") -}}
{{- $bundleFields :=  slice (partial "createField" (dict "key" "thumb" "type" "bundle-image-thumbnail")) -}}
{{- $extensions := (slice "jpg" "png" "jpeg" "pdf" "svg" ) -}}
{{- $field = merge $field (dict "path" $value "extensions" $extensions "fields" $bundleFields ) -}}
{{- end -}}

{{- return $field -}}
